services:
  postgres:
    image: dhi.io/postgres:17-alpine3.22
    env_file: .env.production
    ports:
      - "5432:5432"
    volumes:
      - dagster-postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 3s
      timeout: 1s
      retries: 3

  dagster-webserver:
    build:
      context: ../../
      dockerfile: deploy/docker/dagster-webserver.Dockerfile
    ports:
      - "3000:3000"
    env_file: .env.production
    environment:
      DAGSTER_HOME: /app/config/dagster
    depends_on:
      postgres:
        condition: service_healthy
      dagster-code-server:
        condition: service_healthy
    command:
      [
        "dagster-webserver",
        "-h", "0.0.0.0",
        "-p", "3000",
        "-w", "/app/config/dagster/workspace.yaml",
      ]

  dagster-daemon:
    build:
      context: ../../
      dockerfile: deploy/docker/dagster-webserver.Dockerfile
    env_file: .env.production
    environment:
      DAGSTER_HOME: /app/config/dagster
    volumes:
      - dagster-compute-logs:/app/compute_logs
    depends_on:
      postgres:
        condition: service_healthy
      dagster-code-server:
        condition: service_healthy
    command: ["dagster-daemon", "run"]

  dagster-code-server:
    build:
      context: ../../
      dockerfile: deploy/docker/pluginlake.Dockerfile
    ports:
      - "4000:4000"
    healthcheck:
      test: ["CMD", "dagster", "api", "grpc-health-check", "-p", "4000"]
      interval: 3s
      timeout: 1s
      start_period: 3s
      retries: 3
    command:
      [
        "dagster", "code-server", "start",
        "-h", "0.0.0.0",
        "-p", "4000",
        "-m", "pluginlake.definitions",
      ]

  pluginlake:
    build:
      context: ../../
      dockerfile: deploy/docker/pluginlake.Dockerfile
    env_file: .env.production
    environment:
      PLUGINLAKE_SERVER_HOST: ${PLUGINLAKE_SERVER_HOST:-"0.0.0.0"}
      PLUGINLAKE_SERVER_PORT: ${PLUGINLAKE_SERVER_PORT:-"8000"}
    ports:
      - "${PLUGINLAKE_SERVER_PORT:-8000}:${PLUGINLAKE_SERVER_PORT:-8000}"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:${PLUGINLAKE_SERVER_PORT:-8000}/health')"]
      interval: 5s
      timeout: 3s
      retries: 3
    depends_on:
      postgres:
        condition: service_healthy
    command: ["python", "-m", "pluginlake"]

volumes:
  dagster-postgres:
  dagster-compute-logs:
